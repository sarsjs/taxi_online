rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isAdmin() {
      return request.auth != null && request.auth.token.admin == true;
    }

    function driverAllowed() {
      let driver = get(/databases/$(database)/documents/drivers/$(request.auth.uid));
      let verifiedOk = driver.data.verificado == true
        || (driver.data.createdAt != null
          && request.time < driver.data.createdAt + duration.value(3, 'd'));
      let paymentOk = driver.data.bloqueadoPorPago != true;
      return verifiedOk && paymentOk;
    }

    match /drivers/{driverId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null
        && request.auth.uid == driverId
        && !exists(/databases/$(database)/documents/passengers/$(request.auth.uid));
      allow update: if isAdmin()
        || (
          request.auth != null
          && request.auth.uid == driverId
          && (
            request.resource.data.saldoPendiente == resource.data.saldoPendiente
            || resource.data.saldoPendiente == null
          )
          && (
            request.resource.data.estado == resource.data.estado
            || resource.data.estado == null
          )
          && (
            request.resource.data.rol == resource.data.rol
            || resource.data.rol == null
          )
          && (
            request.resource.data.fechaRegistro == resource.data.fechaRegistro
            || resource.data.fechaRegistro == null
          )
        );
    }

    match /passengers/{passengerId} {
      allow read: if request.auth != null && request.auth.uid == passengerId;
      allow create: if request.auth != null
        && request.auth.uid == passengerId
        && !exists(/databases/$(database)/documents/drivers/$(request.auth.uid));
      allow update: if request.auth != null && request.auth.uid == passengerId;
    }

    match /settings/{docId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }

    match /zones/{zoneId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }

    match /routes/{routeId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }

    match /landmarks/{landmarkId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }

    match /rides/{rideId} {
      allow read, create: if request.auth != null;
      allow update: if request.auth != null
        && (
          resource.data.pasajeroUid == request.auth.uid
          || request.resource.data.pasajeroUid == request.auth.uid
          || (
            (resource.data.driverUid == request.auth.uid
              || request.resource.data.driverUid == request.auth.uid)
            && driverAllowed()
          )
        );
    }
  }
}
